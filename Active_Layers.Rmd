---
title: "Data_Layers"
author: "Sandra Fogg"
date: "11/5/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
# Load the Required Packages
library(tidyverse)
library(sf)
library(sp)
library(rgdal)
library(raster)
library(dplyr)
library(rgeos)
library(scales)
library(fasterize)
library(dismo)
library(maptools)
library(sdmpredictors)
library(maps)
library(ncdf4)
library(marmap)
library(rnaturalearth)
library(wdpar)
library(dplyr)
library(ggmap)

```


Set-Up for Downloading Data Using the "Maricultura" Google Drive File Stream
```{r}
# Create a Root to Extract Files 
if(Sys.info()["sysname"] == "Windows"){ #If operating system is "Windows" use G: Drive
  team_path <- "G:/"
} else { # If it is not (i.e. Mac), use the Google Drive File Stream
  team_path <- "/Volumes/GoogleDrive/"
}

#Create the Full File Path
path <- paste0(team_path, "Shared drives/Bren GP 2020 maricultura/Data/Raw_Data/Active_Data_Layers")

```


Read in Downloaded Data Layers from the Shared Drive: Bren GP 2020 maricultura/Data/Raw_Data/Active_Layers

Exclusive Economic Zone, EEZ, marineregions.org
```{r}

# Read File
eez <- read_sf(dsn = path,
                layer = "eez_v10")

# Filtered to select only Brazil's EEZ
eez_BRA <- eez %>% 
  filter(ISO_Ter1 == "BRA")

# Plot Brazil EEZ
plot(eez_BRA$geometry)

# View CRS
st_crs(eez_BRA)

```

Minimum and Maximum Sea-Surface Temperatures (SST), bio-oracle.org
```{r}
# Download Files
min_sst <- load_layers("BO_sstmin")
max_sst <- load_layers("BO_sstmax")

# View Histograms
hist(min_sst)
hist(max_sst)

# View Plots
plot(min_sst)
plot(max_sst)

# View CRS
 st_crs(min_sst)
 st_crs(max_sst)


# Crop to Brazil EEZ
max_sst_BR <- crop(max_sst, eez_BRA)
min_sst_BR <- crop(min_sst, eez_BRA)


# No Need to Reproject -> In Same CRS as EEZ


# Mask to Brazil EEZ
max_sst_BRA <- mask(max_sst_BR, eez_BRA)
min_sst_BRA <- mask(min_sst_BR, eez_BRA)


# View Cropped Histograms
hist(max_sst_BRA)
hist(min_sst_BRA)


# View Cropped Plots
plot(max_sst_BRA)
plot(min_sst_BRA)

```

Depth, gebco.net
```{r}
# Read file
depth <- raster(paste0(path,"/gebco_2019_n7.045066_s-35.78779_w-54.58321_e-26.01452.tif"))


# View Histograms
hist(depth)


# View Plots
plot(depth)


# View CRS
st_crs(depth)


# No Need to Reproject -> In Same CRS as EEZ


# Crop to Brazil EEZ 
depth_BR <- crop(depth, eez_BRA)

# Mask to Brazil EEZ
depth_BRA <- mask(depth_BR, eez_BRA)

# Resample to Bio-Oracle Cell Size (ATM Bio-Oracle Cell Size is the Standard)
depth_BRA_res <- resample(depth_BRA, min_sst_BRA,method='ngb',progress='text')

# View Cropped Plot
plot(depth_BRA_res)

```


Current Velocity, (Maximum Velocity at Minimum Depth), bio-oracle.org
```{r}
# Download File 
max_cv <- load_layers("BO2_curvelmax_bdmin")


# View Histograms
hist(max_cv)


# View Plots
plot(max_cv)


# View CRS
st_crs(max_cv)


# Crop to Brazil EEZ
current_BR <- crop(max_cv, eez_BRA)


# No Need to Reproject -> In Same CRS as EEZ


# Mask to Brazil EEZ
current_BRA <- mask(current_BR, eez_BRA)


# View Cropped Histogram
hist(current_BRA)


# View Cropped Plot
plot(current_BRA)



```


---------Messy Beyond This Point-----------------

Marine Protected Areas (MPAs) - WWF
```{r}
# Download File
mpas <- read_sf(dsn = path,
                layer = "WDPA_Mar2018_marine-shapefile-polygons")


# Filter MPAs for Brazil
mpas_BR <- mpas %>% 
  filter(ISO3 == "BRA")

# Plot MPAs
plot(mpas_BR$geometry)


# View CRS
st_crs(mpas_BR)


# Already Should be Cropped to Brazil EEZ
#mpas_BRA <- st_crop(mpas_BR, eez_BRA)


# No Need to Reproject -> In Same CRS as EEZ


# Resample to Bio-Oracle Cell Size (ATM Bio-Oracle Cell Size is the Standard)
# Will not work because min_sst_BRA needs to be reprojected

extent <- extent(eez_BRA)
res <-  res(min_sst_BRA)

empty_raster <- raster( extent, resolution = res)
mpas_binary <- rasterize(mpas_BR, empty_raster, field = 0, background = 1)
plot(mpas_binary)
freq(mpas_binary)

# Plot Brazil EEZ
#plot(mpas_rpj)
#Not sure if read in correctly, only 5 files in zip whereas other files zips have 8


#There is a distance function in raster- you feed a raster that has both values and NAs nd it returns raster that calculates distance to nearest non NA cell
#distance to shore

# set max_land_distance <- 25

#land_distance_mask <- land_distance < max_land_distance

# Download Protected Area Data for Brazil (Excludes Areas Represented as Point Localities)
BRA_raw_pa_data <- wdpa_fetch("Brazil")

# Clean the Data. Steps Include: excluding protected areas that are not yet implemented, excluding protected areas with limited conservation value, replacing missing data codes (e.g. "0") with missing data values (i.e. NA), replacing protected areas represented as points with circular protected areas that correspond to their reported extent, repairing any topological issues with the geometries, and erasing overlapping areas. 

# Clean Brazil Data
BRA_pa_data <- wdpa_clean(BRA_raw_pa_data)





```



No-Take Zones
```{r}




```





Artisanal Fishing Areas, WWF - Needs More Info
```{r}

# Download File
artisanal_areas <- read_sf(dsn = path,
                layer = "Artisanal_fishing_Areas")


# View Plots
plot(artisanal_areas)


# View CRS
st_crs(artisanal_areas)


# Reproject to EEZ
artisanal_rpj <- st_transform(artisanal_areas, CRS("+init=epsg:4326"))

# Crop to Brazil EEZ 
artisanal_BR <- crop(artisanal_rpj, eez_BRA)

# Mask to Brazil EEZ
depth_BRA <- mask(depth_BR, eez_BRA)

# Resample to Bio-Oracle Cell Size (ATM Bio-Oracle Cell Size is the Standard)
depth_BRA_res <- resample(depth_BRA, min_sst_BRA,method='ngb',progress='text')

# View Cropped Plot
plot(depth_BRA_res)

```


# Distance from Shore 
```{r}

# Read in Created .tif File from Distance to Shore.Rmd
dist_to_shore <- raster(paste0(path,"/distance_to_shore_coastline.tif"))

# Reclassify Matrix for Distance to Shore
rcl_matrix_dist_shore <- c(-Inf, 0, 0,
                           0, 46300, 1,
                           46300, Inf, 0)

# Reclassify Distance to Shore Layer
dist_shore_binary <- reclassify(distance_nonNA, rcl = rcl_matrix_dist_shore)


#Plot Reclassified Layers
plot(dist_shore_binary)

# View Distance Mask
plot(dist_to_shore)
# NOTE: This mask is distance to NON-LAND, since the land values are the NA. If we want to do distance to LAND, we would have to reverse the mask. It should really matter though, as long as numerically it is 25


# Set Maximum Shore Distance - JC's code
max_shore_distance <- 46300

shore_distance_mask <- dist_to_shore < 46300

plot(shore_distance_mask)

```

To Read in Bio-Oracle
```{r}
#Explore Datasets and Layer Names in the Package 
##Explore Datasets
list_datasets() 

##Explore Layers
list_layers() 

```



To find CRS
```{r}
proj4string(eez)
class(eez)

CRS("+init=epsg:5880")
#CRS arguments:
# +init=epsg:5880 +proj=poly +lat_0=0 +lon_0=-54 +x_0=5000000 +y_0=10000000
#+ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs 

eez_BRA <- eez %>% 
  filter(ISO_Ter1 == "BRA")
```




