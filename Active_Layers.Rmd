---
title: "Active Layers"
date: "11/5/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
# Load the Required Packages
library(tidyverse)
library(sf)
library(sp)
library(rgdal)
library(raster)
library(dplyr)
library(rgeos)
library(scales)
library(fasterize)
library(dismo)
library(maptools)
library(sdmpredictors)
library(leaflet)
library(maps)
library(ncdf4)
library(marmap)
library(rnaturalearth)
library(dplyr)
library(ggmap)
library(rmapshaper)

```


Set-Up for Downloading Data Using the "Maricultura" Google Drive File Stream
```{r}
# Create a Root to Extract Files 
if(Sys.info()["sysname"] == "Windows"){ #If operating system is "Windows" use G: Drive
  team_path <- "G:/"
} else { # If it is not (i.e. Mac), use the Google Drive File Stream
  team_path <- "/Volumes/GoogleDrive/"
}

#Create the Full File Path
path <- paste0(team_path, "Shared drives/Bren GP 2020 maricultura/Data/Raw_Data/Active_Data_Layers")

```


Read in Downloaded Data Layers from the Shared Drive: Bren GP 2020 maricultura/Data/Raw_Data/Active_Layers

Naming our Projection
```{r}
# Define CRS
crs_BRA <- "+proj=poly +lat_0=0 +lon_0=-54 +x_0=5000000 +y_0=10000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"

```

Exclusive Economic Zone, EEZ, marineregions.org
```{r}

# Read File
eez <- read_sf(dsn = path,
                layer = "eez_v10")

# Filtered to select only Brazil's EEZ
eez_BRA <- eez %>% 
  filter(ISO_Ter1 == "BRA")

# Reproject EEZ
eez_BRA <- st_transform(eez_BRA, crs_BRA)

# Plot Brazil EEZ
plot(eez_BRA$geometry)

# View CRS
#st_crs(eez_BRA)


```

To Read in Bio-Oracle
Minimum and Maximum Sea-Surface Temperatures (SST), bio-oracle.org
```{r}

# Download Files
min_sst <- load_layers("BO_sstmin")
max_sst <- load_layers("BO_sstmax")

# View Histograms
#hist(min_sst)
#hist(max_sst)

# View Plots
#plot(min_sst)
#plot(max_sst)

# Reproject to 5880 (Brazil's CRS)
min_sst_proj <-  projectRaster(min_sst, crs = crs_BRA)
max_sst_proj <-  projectRaster(max_sst, crs = crs_BRA)

# View CRS
st_crs(min_sst_proj)
st_crs(max_sst_proj)

# Crop to Brazil EEZ
max_sst_crop <- crop(max_sst_proj, eez_BRA)
min_sst_crop <- crop(min_sst_proj, eez_BRA)

# Mask to Brazil EEZ
max_sst_mask <- mask(max_sst_crop, eez_BRA)
min_sst_mask <- mask(min_sst_crop, eez_BRA)

# View Cropped Histograms
#hist(max_sst_BRA)
#hist(min_sst_BRA)

# View Cropped Plots
#plot(max_sst_mask)
#plot(min_sst_BRA)


# Write a Raster for Suitability Analysis
writeRaster(max_sst_mask, paste0(path, "/max_sst_mask"), overwrite = T)
writeRaster(min_sst_mask, paste0(path, "/min_sst_mask"), overwrite = T)

```


Create an Empty Raster Using EEZ Extent and Bio-Oracle Cell Size
```{r}
# Set the Resolution and Extent for Empty Raster
extent <- extent(eez_BRA)
res <-  res(min_sst_mask)

# Create an Empty Raster 
empty_raster <- raster( extent, resolution = res)

```


Depth, gebco.net
```{r}

# Read File
depth <- raster(paste0(path,"/gebco_2019_n7.045066_s-35.78779_w-54.58321_e-26.01452.tif"))

# View Histograms
#hist(depth)

# View Plots
#plot(depth)

# View CRS
#st_crs(depth)

# Reproject to 5880 (Brazil's CRS)
depth_proj <- projectRaster(depth, crs = crs_BRA)

# Resample to Bio-Oracle Cell Size (ATM Bio-Oracle Cell Size is the Standard)
depth_resample <- resample(depth_proj, min_sst_crop,method='ngb',progress='text')

# Crop to Brazil EEZ 
depth_crop <- crop(depth_resample, eez_BRA)

# Mask to Brazil EEZ
depth_mask <- mask(depth_crop, eez_BRA)

# Write a Raster for Suitability Analysis
writeRaster(depth_binary, paste0(path, "/depth_mask", overwrite = T))


```


Current Velocity, (Maximum Velocity at Minimum Depth), bio-oracle.org
```{r}

# Download File 
max_cv <- load_layers("BO2_curvelmax_bdmin")

# View Histograms
#hist(max_cv)

# View Plots
#plot(max_cv)

# View CRS
#st_crs(max_cv)

# Reproject to 5880 (Brazil's CRS)
max_cv_proj <-  projectRaster(max_cv, crs = crs_BRA)

# Crop to Brazil EEZ
max_cv_crop <- crop(max_cv_proj, eez_BRA)

# Mask to Brazil EEZ
max_cv_mask <- mask(max_cv_crop, eez_BRA)

# View Cropped Histogram
#hist(max_cv_mask)

# View Cropped Plot
#plot(max_cv_mask)

# Reclassify
# Reclassification Matrix for Current 
 rcl_max_current <- c(-Inf, 1, 1,
                    1, Inf, 0)

 # Reclassify the Max Current
 current_binary <- reclassify(max_cv_mask, rcl= rcl_max_current)

 # Plot reclassified layer
 plot(current_binary)
 
 # Write a Raster for Suitability Analysis
writeRaster(current_binary, paste0(path, "/current_binary", overwrite = T))


```


Marine Protected Areas (MPAs) - WWF
```{r}

# Download File
mpas <- read_sf(dsn = path,
                layer = "WDPA_Mar2018_marine-shapefile-polygons")


# Filter MPAs for Brazil
mpas_BRA <- mpas %>% 
  filter(ISO3 == "BRA")

# Plot MPAs
#plot(mpas_BR$geometry)

# View CRS
#st_crs(mpas_BR)

# Reproject to 5880 (Brazil's CRS)
mpas_proj <- st_transform(mpas_BRA, crs = crs_BRA)

# No Need to Crop to Brazil EEZ because Already Filtered for Brazil and Extent is set to EEZ

# Do Not Need to Resample because MPAs is a Polygon

# Rasterizing Steps for MPA Layer
# Create a Binary MPA Raster
mpas_binary <- rasterize(mpas_proj, empty_raster, field = 0, background = 1) %>% 
  mask(eez_BRA)

# Plot Reclassified MPA Layer
plot(mpas_binary)
#freq(mpas_binary)

# Write a Raster for Suitability Analysis
writeRaster(mpas_binary, paste0(path, "/mpas_binary", overwrite = T))

```

Reefs
```{r}
# Read in, Reproject, and Simplify Reefs Layer and Remove Z Dimension
marine_ecosystems <- st_read(dsn = path, layer = "apzcm_alvo_ecossistemas_marinhos") %>% 
  st_transform(crs_BRA) %>% 
  ms_simplify(keep_shapes = TRUE) %>% 
  st_zm(drop = TRUE, what = "ZM")

# Create a Binary Reefs Rasters
reefs_binary <- rasterize(marine_ecosystems, empty_raster, field = 0, background = 1) %>% 
  mask(eez_BRA)

# View Plots
plot(reefs_binary)

# Write a Raster for Suitability Analysis
writeRaster(reefs_binary, paste0(path, "/reefs_binary", overwrite = T))

```

---------Messy Beyond This Point-----------------

Distance to shore (Anna)
```{r}
# Import the limits of Brazil #110, 50, or 10 meters for scale (resolution)
bound_BRA <- ne_countries(scale = 110, country = "Brazil", returnclass = "sf") %>%
  st_transform(crs_BRA) %>% 
  sf::st_crop(eez_BRA)

# Rasterize coastline
coastline_raster <- rasterize(bound_BRA, empty_raster, field = 1)

# Calculate distance to nearest non-NA pixel and mask to EEZ
dist_shore <- distance(coastline_raster)%>% 
  mask(eez_BRA)

# Plot
plot(dist_shore)

# Export raster
writeRaster(x = dist_shore, filename = paste0(path,"/dist_shore.tif"), overwrite = T)
```







Wave Height
```{r}

# Download File
waves <- raster("G:/Shared drives/Bren GP 2020 maricultura/Data/Raw_Data/Active_Data_Layers/aq_waveheight.asc")
plot(waves)
```






Artisanal Fishing Areas, WWF - Needs More Info - Maybe Better to Leave for Discussion
```{r}

# Download File
artisanal_areas <- read_sf(dsn = path,
                layer = "Artisanal_fishing_Areas")


# View Plots
plot(artisanal_areas$geometry)


# View CRS
st_crs(artisanal_areas)


# Reproject to EEZ
artisanal_rpj <- st_transform(artisanal_areas, CRS("+init=epsg:4326"))

# Crop to Brazil EEZ 
artisanal_BR <- crop(artisanal_rpj, eez_BRA)

# Mask to Brazil EEZ
depth_BRA <- mask(depth_BR, eez_BRA)

# Resample to Bio-Oracle Cell Size (ATM Bio-Oracle Cell Size is the Standard)
depth_BRA_res <- resample(depth_BRA, min_sst_BRA,method='ngb',progress='text')

# View Cropped Plot
plot(depth_BRA_res)

```


# Distance from Shore 
```{r}

# Read in Created .tif File from Distance to Shore.Rmd
dist_to_shore <- raster(paste0(path,"/distance_to_shore_coastline.tif"))

# Reclassify Matrix for Distance to Shore
rcl_matrix_dist_shore <- c(-Inf, 0, 0,
                           0, 46300, 1,
                           46300, Inf, 0)

# Reclassify Distance to Shore Layer
dist_shore_binary <- reclassify(distance_nonNA, rcl = rcl_matrix_dist_shore)


#Plot Reclassified Layers
plot(dist_shore_binary)

# View Distance Mask
plot(dist_to_shore)
# NOTE: This mask is distance to NON-LAND, since the land values are the NA. If we want to do distance to LAND, we would have to reverse the mask. It should really matter though, as long as numerically it is 25


# Set Maximum Shore Distance - JC's code
max_shore_distance <- 46300

shore_distance_mask <- dist_to_shore < 46300

plot(shore_distance_mask)

```








