---
title: "Suitability"
author: "Anna Calle"
date: "11/8/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Load required packages
library(rnaturalearthdata)
library(rnaturalearth)
library(sf)
library(raster)
```


Suitability 

- Depth: 25-100m
- Min sea surface temp: >22째C
- Max sea surface temp: <30째C
- Distance to shore: <25 nautical miles
- Current velocity: <1m/s
- Min dissolved oxygen: >4.41 mg/L (200.5 umol/L O2)

Defining variables
```{r}
min_depth <- -25 
max_depth <- -100
min_sst_value <- 22
max_sst_value <- 32
max_dist_shore <- 46300 #25 nautical miles converted to meters
max_cv_value <- 1
min_DO_value <- 200.5

```

Set-Up for Downloading Data Using the "Maricultura" Google Drive File Stream
```{r}
# Create a Root to Extract Files 
if(Sys.info()["sysname"] == "Windows"){ #If operating system is "Windows" use G: Drive
  team_path <- "G:/"
} else { # If it is not (i.e. Mac), use the Google Drive File Stream
  team_path <- "/Volumes/GoogleDrive/"
}

#Create the Full File Path
path <- paste0(team_path, "Shared drives/Bren GP 2020 maricultura/Data/Raw_Data/Active_Data_Layers")

```

CRS
```{r}
# Assign projection: SIRGAS 2000 / Brazil Polyconic
crs_BRA <- "+proj=poly +lat_0=0 +lon_0=-54 +x_0=5000000 +y_0=10000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"
```

Data for graphs
```{r}
# Read in Brazil's EEZ
eez_BRA <- read_sf(dsn = path,
                layer = "eez_BRA")
# Brazil's outline in correct projection and cropped to the EEZ's extent
bound_BRA <- ne_countries(scale = 50, country = "Brazil", returnclass = "sf") %>%
  st_transform(crs_BRA) %>% 
  sf::st_crop( bound_BRA, y = extent(eez_BRA))


```



Reclassifying depth to have 1s only if it's in between 25-100m, and 0s otherwise
```{r}
# Read in file
depth_mask <- raster(paste0(path,"/depth_mask.tif"))

# Reclassification matrix for depth layer
rcl_mat_depth <- c(-Inf, max_depth, 0,
                   max_depth, min_depth, 1,
                   min_depth, Inf, 0)

# Reclassify the depth layer
depth_binary <- reclassify(depth_mask,rcl= rcl_mat_depth)

# Plot reclassified layer
plot(depth_binary)

# Make df
depth_binary_df <- as.data.frame(depth_binary, xy = T)

# Graph with Brazil's outline
depth_binary_graph <- ggplot() +
    geom_raster(data = depth_binary_df,
                mapping = aes(x = x, y = y, fill = depth_mask)) +
    geom_sf(data = bound_BRA) +
  theme_void() +
  theme(panel.grid.major = element_line(color = "white"))

depth_binary_graph

```

Reclassify min SST layer to have 1s only if it is above 22째C, and 0s otherwise
```{r}
# Read in file
min_sst_mask <- raster(paste0(path,"/min_sst_mask.tif"))

# Reclassification matrix for min SST
rcl_matrix_min <- c( -Inf, min_sst_value, 0,
                min_sst_value, Inf, 1)

# Reclassify min SST
sst_binary_min <- reclassify(min_sst_mask, rcl = rcl_matrix_min)

# Plot reclassified layer
plot(sst_binary_min)

# Make df
sst_binary_min_df <- as.data.frame(sst_binary_min, xy = T)

# Graph with Brazil's outline
sst_binary_min_graph <- ggplot() +
    geom_raster(data = sst_binary_min_df,
                mapping = aes(x = x, y = y, fill = min_sst_mask)) +
    geom_sf(data = bound_BRA) +
  theme_void() +
  theme(panel.grid.major = element_line(color = "white"))

sst_binary_min_graph
```

Reclassify max SST layer to have 1s only if it is less than 30째C, and 0s otherwise
```{r}
# Read in file
max_sst_mask <- raster(paste0(path,"/max_sst_mask.tif"))

# Reclassify matrix for max SST layer
rcl_matrix_max <- c( -Inf, max_sst_value, 1,
                max_sst_value, Inf, 0)

# Reclassify max SST layer
sst_binary_max <- reclassify(max_sst_mask, rcl = rcl_matrix_max)

# Plot reclassified layer
plot(sst_binary_max)

# Make df
sst_binary_max_df <- as.data.frame(sst_binary_max, xy = T)

# Graph with Brazil's outline
sst_binary_max_graph <- ggplot() +
    geom_raster(data = sst_binary_max_df,
                mapping = aes(x = x, y = y, fill = max_sst_mask)) +
    geom_sf(data = bound_BRA) +
  theme_void() +
  theme(panel.grid.major = element_line(color = "white"))

sst_binary_max_graph

```

Reclassify max current velocity to have 1s only if it is less than 1m/s, and 0s otherwise
```{r}
# Read in file
max_cv_mask <- raster(paste0(path,"/max_cv_mask.tif"))

# Reclassification matrix for current layer
rcl_mat_current <- c(-Inf, max_cv_value, 1,
                   max_cv_value, Inf, 0)

# Reclassify the depth layer
current_binary <- reclassify(max_cv_mask ,rcl= rcl_mat_current)

# Plot reclassified layer
plot(current_binary)

# Make df
current_binary_df <- as.data.frame(current_binary, xy = T)

# Graph with Brazil's outline
current_binary_graph <- ggplot() +
    geom_raster(data = current_binary_df,
                mapping = aes(x = x, y = y, fill = max_cv_mask)) +
    geom_sf(data = bound_BRA) +
  theme_void() +
  theme(panel.grid.major = element_line(color = "white"))

current_binary_graph

```

Reclassify distance to shore layer to have 1s only if it is less than 25nm, and 0s otherwise
```{r}
# Read in file
dist_shore <- raster(paste0(path,"/dist_shore.tif"))

# Reclassify matrix for distance to shore layer
rcl_matrix_dist_shore <- c( -Inf, 0, 0,
                            0, max_dist_shore, 1,
                            max_dist_shore, Inf, 0)

# Reclassify distance to shore layer
dist_shore_binary <- reclassify(dist_shore, rcl = rcl_matrix_dist_shore)

# Plot reclassified layer
plot(dist_shore_binary)

# Make df
dist_shore_binary_df <- as.data.frame(dist_shore_binary, xy = T)

# Graph with Brazil's outline
dist_shore_binary_graph <- ggplot() +
    geom_raster(data = dist_shore_binary_df,
                mapping = aes(x = x, y = y, fill = dist_shore)) +
    geom_sf(data = bound_BRA) +
  theme_void() +
  theme(panel.grid.major = element_line(color = "white"))

dist_shore_binary_graph

```

Reclassify DO layer to have 1s only if it is above 200.5 umol, and 0s otherwise
```{r}

# Units? \xbemol/m\x9f mol/ m3
# Read in file
DO_min_mask <- raster(paste0(path,"/DO_min_mask.tif"))

# Reclassification matrix for DO
rcl_matrix_DO <- c( -Inf, min_DO_value, 0,
                min_DO_value, Inf, 1)

# Reclassify DO min
DO_min_binary <- reclassify(DO_min_mask, rcl = rcl_matrix_DO)

# Plot reclassified layer
plot(DO_min_binary)

# Make df
DO_min_binary_df <- as.data.frame(DO_min_binary, xy = T)

# Graph with Brazil's outline
DO_min_binary_graph <- ggplot() +
    geom_raster(data = DO_min_binary_df,
                mapping = aes(x = x, y = y, fill = DO_min_mask)) +
    geom_sf(data = bound_BRA) +
  theme_void() +
  theme(panel.grid.major = element_line(color = "white"))

DO_min_binary_graph
```


Suitable areas
```{r}
# Overlay all layers
# Note: they all need to have the same extent and resolution
suitable <- overlay(sst_binary_min, sst_binary_max, depth_binary, current_binary, dist_shore_binary, fun = function(a, b, c, d, e){a*b*c*d*e})

# Plot suitable areas
plot(suitable)

```

Finalized graph
```{r}
# Convert suitable raster to dataframe
suitable_df <- as.data.frame(suitable, xy = T) %>% 
  mutate(suitable= case_when(
    layer == 1 ~ "Suitable",
    layer != 1 ~ "Not Suitable"
  ))

# Create finalized graph
suitable_graph <- ggplot() +
    geom_raster(data = suitable_df,
                mapping = aes(x = x, y = y, fill = suitable)) +
  scale_fill_manual(
    name = "", # Gives an empty title for the legend
    labels = c("Not Suitable", "Suitable", ""),
    values = c("lightblue1", "orange")) +
    geom_sf(data = bound_BRA) +
  theme_void() +
  theme(panel.grid.major = element_line(color = "white"))

### Additional code we could use
# To add EEZ outline:
# geom_sf(data = eez_BRA, fill = "transparent")

# To add titles and subtitles:
# labs(title = "Title",
# subtitle = "Subtitle",
# x = "x lab", y = "y lab")

suitable_graph


```

Env. constrains
```{r}
# Following presentation slides
env_constrains <-  overlay(sst_binary_min, sst_binary_max,current_binary, fun = function(a, b, c){a*b*c})

# Plot
plot(env_constrains)

# Convert env. constrains raster to dataframe
env_constrains_df <- as.data.frame(env_constrains, xy = T) %>% 
  mutate(suitable= case_when(
    layer == 1 ~ "Suitable",
    layer != 1 ~ "Not Suitable"
  ))

# Create finalized graph
env_constrains_graph <- ggplot() +
    geom_raster(data = env_constrains_df,
                mapping = aes(x = x, y = y, fill = suitable)) +
  scale_fill_manual(
    name = "", # Gives an empty title for the legend
    labels = c("Not Suitable", "Suitable", ""),
    values = c("lightblue1", "orange")) +
    geom_sf(data = bound_BRA) +
  theme_void() +
  theme(panel.grid.major = element_line(color = "white"))

env_constrains_graph

```

Cropped Layers
```{r}
# Following presentation slides
cropped_layers <-  overlay(mpas_binary, reefs_binary, reefs_artificial_binary, og_pipeline_binary, og_production_binary, fun = function(a, b, c, d, e){a*b*c*d*e})

# Plot
plot(cropped_layers)

# Convert env. constrains raster to dataframe
cropped_layers_df <- as.data.frame(cropped_layers, xy = T) %>% 
  mutate(suitable= case_when(
    layer == 1 ~ "Suitable",
    layer != 1 ~ "Not Suitable"
  ))

# Create finalized graph
cropped_layers_graph <- ggplot() +
    geom_raster(data = cropped_layers_df,
                mapping = aes(x = x, y = y, fill = suitable)) +
  scale_fill_manual(
    name = "", # Gives an empty title for the legend
    labels = c("Not Suitable", "Suitable", ""),
    values = c("lightblue1", "orange")) +
    geom_sf(data = bound_BRA) +
  theme_void() +
  theme(panel.grid.major = element_line(color = "white"))

cropped_layers_graph

```

All Layers
```{r}
# Following presentation slides
all_layers <-  overlay(sst_binary_min, sst_binary_max, depth_binary, current_binary, dist_shore_binary, mpas_binary, reefs_binary, reefs_artificial_binary, og_pipeline_binary, og_production_binary, fun = function(a, b, c, d, e, f, g, h, i, j){a*b*c*d*e*f*g*h*i*j})

# Plot
plot(all_layers)

# Convert env. constrains raster to dataframe
all_layers_df <- as.data.frame(all_layers, xy = T) %>% 
  mutate(suitable= case_when(
    layer == 1 ~ "Suitable",
    layer != 1 ~ "Not Suitable"
  ))

# Create finalized graph
all_layers_graph <- ggplot() +
    geom_raster(data = all_layers_df,
                mapping = aes(x = x, y = y, fill = suitable)) +
  scale_fill_manual(
    name = "", # Gives an empty title for the legend
    labels = c("Not Suitable", "Suitable", ""),
    values = c("lightblue1", "orange")) +
    geom_sf(data = bound_BRA) +
  theme_void() +
  theme(panel.grid.major = element_line(color = "white"))

all_layers_graph


```



Total suitable area calculation
```{r}
a <- area(suitable)
plot(a)
b <- (suitable * a)
plot(b)

sum(values(b), na.rm = T) # 36039808000 m^2 or 36039.808 km^2
```

Total cropped layers area calculation
```{r}
a_cropped_layers <- area(cropped_layers)
plot(a_cropped_layers)
b_cropped_layers <- (cropped_layers * a_cropped_layers)
plot(b_cropped_layers)

sum(values(b_cropped_layers), na.rm = T) #2.653122e+12 m^2 or 2653122 km^2
```


Total all layers area calculation
```{r}
a_all_layers <- area(all_layers)
plot(a_all_layers)
b_all_layers <- (all_layers * a_all_layers)
plot(b_all_layers)

sum(values(b_all_layers), na.rm = T) #24561376000 m^2 or 24561 km^2
```






